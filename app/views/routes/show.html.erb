<h1><%= @route.name %></h1>

<!-- markers => {data: @json, options: {draggable: true} } -->
<% gmaps(direction: {options: {waypoints: @waypoints.collect{|w| w.position},travelMode: "WALKING"},data: {from: @waypoints.first.position, to: @waypoints.last.position} }) %>
<div id="waypoints" style="width: 900px; height: 300px;"></div>

<%= link_to 'Edit', edit_route_path(@route) %> |
<%= link_to 'Back', routes_path %>

<script type="text/javascript">
      var rendererOptions = {
    draggable: true
  };
  var directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);;
  var directionsService = new google.maps.DirectionsService();
  var map;

  var poland = new google.maps.LatLng(54.381579,18.596039);

$(function(){

    var myOptions = {
      zoom: 7,
      mapTypeId: google.maps.MapTypeId.TERRAIN,
      center: poland
    };
    map = new google.maps.Map(document.getElementById("waypoints"), myOptions);
    directionsDisplay.setMap(map);

    google.maps.event.addListener(directionsDisplay, 'directions_changed', function() {
      computeTotalDistance(directionsDisplay.directions);
              console.log("mam trase");
    });

    calcRoute();
  });

  function calcRoute() {

    var request = {
      origin: "<%= @waypoints.first.position %>",
      unitSystem: google.maps.UnitSystem.METRIC,
      destination:  "<%= @waypoints.last.position %>",
      waypoints:<%= @waypoints.collect{|w| {location: w.position}}.to_json.html_safe %>,
      travelMode: google.maps.DirectionsTravelMode.WALKING
    };
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      }
    });
  }

  function computeTotalDistance(result) {
    var total = 0;
    var myroute = result.routes[0];
    for (i = 0; i < myroute.legs.length; i++) {
      total += myroute.legs[i].distance.value;
    }
    total = total / 1000.
  }
</script>